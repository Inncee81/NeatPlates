# LibClassicThreat

## Background

With the release of Classic World of Warcraft, Blizzard have removed the modern threat API functionality. LibThreat is an attempt to bridge that gap. LibThreat uses addon messages to send threat information across the party, attempting to calculate the current threat table of a given mob. 

## TODO
- Add support to estimate the current threat of unit's who aren't using this Lib
- Play test some of the items and buffs
- Add boss transition threat resets
- Finish adding in all tier set changes
## Usage

**LibThreat** has a function that mirrors that of the current live `UnitDetailedThreatSituation`: `Lib.DetailedThreatSituation("unit", "mob")` 

#### Parameters

- `"mob"` - The UnitID of the mob that would you like to query the threat table of. 
- `"unit"` - The unit of which you would like to get the current threat information.

#### Return value
`isTanking, status, threatpct, rawthreatpct, threatvalue`
- **isTanking:** - Integer - returns 1 if the unit is primary threat target of the mob (is tanking), or nil otherwise.
- **status:** - Integer - returns the threat status for the unit on the mob, or nil if unit is not on mob's threat table. (3 = securely tanking, 2 = insecurely tanking, 1 = not tanking but higher threat than tank, 0 = not tanking and lower threat than tank)
- **threatPct:** - Number - returns the unit's threat on the mob as a percentage of the amount required to pull aggro, scaled according to the unit's range from the mob. At 100 the unit will pull aggro. Returns 100 if the unit is tanking and nil if the unit is not on the mob's threat list.
- **rawthreatpct:** - Number - returns the unit's threat as a percentage of the tank's current threat. Returns nil if the unit is not on the mob's threat list.
- **threatvalue:** - Number - returns the unit's total threat on the mob.

Exact same returns as the live version of `UnitDetailedThreatSituation("unit", "mob")` (https://wow.gamepedia.com/API_UnitDetailedThreatSituation) 

#### Player Threat Information
Lib.myThreatMulti is a table that holds all the information about the players current threat modifiers. The below variables are held inside of the table. 
- **"global":** - The global threat multiplier.
- **"stance":** - The current stance's threat multiplier.
- **"spell":** - The spell multiplier.
- **"aura":** - The threat multiplier of all current aruas.
- **"healing":** - The healing multiplier, if the player casts a heal. 
- **"melee":** - The melee multiplier.
- **"range":** - The range multiplier. 
- **"rage":** - The amount of threat generated by regenerating rage. 
- **"energy":** - The amount of threat generated by regenerating energy. 
- **"mana":** - The amount of threat generated by regenerating mana. 
- **"school":** - The current threat multiplier of a spell school, queried by calling Lib.myThreatMulti["school"][schoolIndex]

The next three variables are tables that list any changes to spells, auras and stances that have been applied. These include things like talents and tier set changes. For example, inside of the "spells" table the layout is as follows. 
```
Lib.myThreatMulti["spells"][spellId] = {
  ["multi"] = 1, -- the changes to the spells threat multiplier, if one exists.
  ["threat"] = +25, -- the additional threat the spell will generate or remove, if it does.
}
```
- **"spells":** - A list of spells that have had their threat variables changed
- **"auraChanges":** - A list of auras that have had their threat variables changed
- **stanceChanges:** - A list of stances that have had their threat variables changed

#### Mob Threat Tables 
**LibClassicThreat-1.0** holds a list of all current threat tables inside of `Lib.GUIDThreatTable` the key's for the table are a mob's GUID, querying this will result in a table with keys of the units on the threat table, with the values being their current threatvalue. 
For example inside of `Lib.GUIDThreatTable[mobGUID]` will hold a list of all unit's currently on the mob's threat table, and `Lib.GUIDThreatTable[mobGUID][playerGUID]` will return the current threatvalue of the player on the mob's threat table. 

```
-- Table Layout
Lib.GUIDThreatTable = {
  [mobGUID] = {
    [playerGUID] = threatvalue
  }
}
```
#### CallBackHandler Events 
**LibClassicThreat** will fire events for `UNIT_THREAT_LIST_UPDATE` and `UNIT_THREAT_SITUATION_UPDATE` much like the live version of the game. At the moment these have no arguments but I'll be adding them soon.
